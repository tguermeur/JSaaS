rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    function getUserData() {
      let userRef = firestore.get(/databases/(default)/documents/users/$(request.auth.uid));
      return userRef.exists ? userRef.data : null;
    }

    match /templates/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    match /cvs/{userId}/{fileName} {
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        (getUserData() != null && (getUserData().role in ['admin', 'superadmin'] || getUserData().status in ['admin', 'superadmin']))
      );

      allow write: if request.auth != null && 
        request.auth.uid == userId;
      
      allow create: if request.auth != null && 
        request.auth.uid == userId &&
        request.resource.size < 5 * 1024 * 1024 && // 5MB max
        (
          request.resource.contentType == 'application/pdf' ||
          request.resource.contentType == 'application/msword' ||
          request.resource.contentType == 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
        );

      allow update: if request.auth != null && 
        request.auth.uid == userId;
      
      allow delete: if request.auth != null && 
        request.auth.uid == userId;
    }
    
    match /profilePictures/{userId} {
      // Permettre la lecture publique des images de profil (nécessaire pour les URLs générées)
      allow read: if true;
      // Seul le propriétaire peut écrire/modifier sa photo de profil
      allow write: if request.auth != null && request.auth.uid == userId &&
        request.resource.size < 5 * 1024 * 1024 && // 5MB max
        request.resource.contentType.matches('image/.*');
    }
    
    match /error-reports/{userId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // Valider le type et la taille de l'image
      allow create: if request.resource.size < 5 * 1024 * 1024 && 
        request.resource.contentType.matches('image/.*');
    }

    // Nouvelle règle simplifiée pour les logos des structures
    match /structures/{structureId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        request.resource.size < 5 * 1024 * 1024 && 
        request.resource.contentType.matches('image/.*');
    }
    
    // Règles pour les logos des entreprises
    match /company-logos/{companyId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        request.resource.size < 5 * 1024 * 1024 && 
        request.resource.contentType.matches('image/.*');
    }

    match /missions/{missionId}/documents/{document} {
      // Fonction pour récupérer les données de la mission
      function getMissionData() {
        return firestore.get(/databases/(default)/documents/missions/$(missionId));
      }
      
      // Fonction simplifiée pour vérifier si l'utilisateur peut écrire
      // Priorité: superadmin > admin/member de la structure > créateur > permissions explicites
      function canWrite() {
        let userData = getUserData();
        let missionData = getMissionData();
        
        // Superadmin a toujours accès
        return (userData != null && (userData.status == 'superadmin' || userData.role == 'superadmin')) ||
               // Admin ou member de la même structure que la mission
               (userData != null && 
                missionData.exists &&
                userData.structureId != null &&
                missionData.data.structureId != null &&
                userData.structureId == missionData.data.structureId &&
                (userData.status == 'admin' || 
                 userData.status == 'member' || 
                 userData.status == 'membre' || 
                 userData.status == 'admin_structure')) ||
               // Créateur de la mission
               (missionData.exists && 
                missionData.data.createdBy != null && 
                missionData.data.createdBy == request.auth.uid) ||
               // Permissions explicites (viewers ou editors)
               (missionData.exists && 
                missionData.data.permissions != null &&
                ((missionData.data.permissions.viewers != null && missionData.data.permissions.viewers.hasAny([request.auth.uid])) ||
                 (missionData.data.permissions.editors != null && missionData.data.permissions.editors.hasAny([request.auth.uid]))));
      }
      
      // Fonction pour vérifier la lecture
      function canRead() {
        let userData = getUserData();
        let missionData = getMissionData();
        
        // Superadmin a toujours accès
        return (userData != null && (userData.status == 'superadmin' || userData.role == 'superadmin')) ||
               // Admin/member/étudiant de la même structure
               (userData != null && 
                missionData.exists &&
                userData.structureId != null &&
                missionData.data.structureId != null &&
                userData.structureId == missionData.data.structureId &&
                (userData.status == 'admin' || 
                 userData.status == 'member' || 
                 userData.status == 'membre' || 
                 userData.status == 'admin_structure' ||
                 userData.status == 'etudiant')) ||
               // Créateur de la mission
               (missionData.exists && 
                missionData.data.createdBy != null && 
                missionData.data.createdBy == request.auth.uid) ||
               // Permissions explicites (viewers ou editors)
               (missionData.exists && 
                missionData.data.permissions != null &&
                ((missionData.data.permissions.viewers != null && missionData.data.permissions.viewers.hasAny([request.auth.uid])) ||
                 (missionData.data.permissions.editors != null && missionData.data.permissions.editors.hasAny([request.auth.uid]))));
      }
      
      // Lecture
      // Version simplifiée pour debug : permettre à tous les utilisateurs authentifiés
      allow read: if request.auth != null;
      
      // Création
      // Version simplifiée pour debug : permettre à tous les utilisateurs authentifiés
      allow create: if request.auth != null &&
        request.resource.size < 10 * 1024 * 1024 && // 10MB max
        (
          request.resource.contentType == 'application/pdf' ||
          request.resource.contentType == 'application/msword' ||
          request.resource.contentType == 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' ||
          request.resource.contentType == 'application/vnd.openxmlformats-officedocument.presentationml.presentation' ||
          request.resource.contentType == 'application/vnd.ms-powerpoint' ||
          request.resource.contentType == 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
          request.resource.contentType == 'application/vnd.ms-excel' ||
          request.resource.contentType.matches('image/.*') ||
          request.resource.contentType.matches('text/.*')
        );
      
      // Modification
      // Version simplifiée pour debug : permettre à tous les utilisateurs authentifiés
      allow update: if request.auth != null &&
        request.resource.size < 10 * 1024 * 1024 && // 10MB max
        (
          request.resource.contentType == 'application/pdf' ||
          request.resource.contentType == 'application/msword' ||
          request.resource.contentType == 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' ||
          request.resource.contentType == 'application/vnd.openxmlformats-officedocument.presentationml.presentation' ||
          request.resource.contentType == 'application/vnd.ms-powerpoint' ||
          request.resource.contentType == 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
          request.resource.contentType == 'application/vnd.ms-excel' ||
          request.resource.contentType.matches('image/.*') ||
          request.resource.contentType.matches('text/.*')
        );
      
      // Suppression
      // Version simplifiée pour debug : permettre à tous les utilisateurs authentifiés
      allow delete: if request.auth != null;
    }

    // Règles pour les documents des entreprises
    match /companies/{companyId}/documents/{fileName} {
      allow read: if request.auth != null;
      allow create: if request.auth != null &&
        request.resource.size < 10 * 1024 * 1024 && // 10MB max
        request.resource.contentType == 'application/pdf';
      allow update: if request.auth != null &&
        request.resource.size < 10 * 1024 * 1024 && // 10MB max
        request.resource.contentType == 'application/pdf';
      allow delete: if request.auth != null;
    }

    // Règles pour les justificatifs de notes de frais
    match /expenses/{userId}/{missionId}/{fileName} {
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        (getUserData() != null && getUserData().status in ['admin', 'superadmin'])
      );

      allow create: if request.auth != null && 
        request.auth.uid == userId &&
        request.resource.size < 5 * 1024 * 1024 && // 5MB max
        (
          request.resource.contentType.matches('image/.*') ||
          request.resource.contentType == 'application/pdf'
        );

      allow update: if request.auth != null && 
        request.auth.uid == userId;

      allow delete: if request.auth != null && 
        request.auth.uid == userId;
    }

    // Règles pour les mails et images uploadés sur les prospects
    match /prospects/{prospectId}/mails/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        (getUserData() != null && (getUserData().role in ['member', 'admin', 'superadmin'] || getUserData().status in ['member', 'admin', 'superadmin']))
      );
      allow create: if request.auth != null && (
        (getUserData() != null && (getUserData().role in ['member', 'admin', 'superadmin'] || getUserData().status in ['member', 'admin', 'superadmin']))
      ) &&
        request.resource.size < 10 * 1024 * 1024 && // 10MB max
        (
          request.resource.contentType.matches('image/.*') ||
          request.resource.contentType == 'application/pdf' ||
          request.resource.contentType == 'message/rfc822' // pour les mails .eml
        );
    }

    // Règles pour les documents de la structure
    match /structures/{structureId}/documents/{fileId} {
      // Fonction pour vérifier si l'utilisateur est superadmin
      function isSuperAdmin() {
        // Utiliser directement firestore.get() au lieu de getUserData() pour éviter les problèmes de cache
        let userRef = firestore.get(/databases/(default)/documents/users/$(request.auth.uid));
        let userData = userRef.exists ? userRef.data : null;
        return userData != null && 
               (userData.status == 'superadmin' || userData.role == 'superadmin');
      }

      // Fonction pour vérifier si l'utilisateur appartient à la structure
      function belongsToStructure() {
        // Utiliser directement firestore.get() au lieu de getUserData() pour éviter les problèmes de cache
        let userRef = firestore.get(/databases/(default)/documents/users/$(request.auth.uid));
        let userData = userRef.exists ? userRef.data : null;
        return userData != null && 
               userData.structureId != null &&
               userData.structureId != '' &&
               userData.structureId == structureId &&
               (userData.status == 'admin' || 
                userData.status == 'member' || 
                userData.status == 'membre' || 
                userData.status == 'admin_structure' || 
                isSuperAdmin());
      }

      // Fonction pour vérifier l'accès aux documents restreints (pour la lecture)
      function canAccessRestrictedFile() {
        // Utiliser directement firestore.get() au lieu de getUserData() pour éviter les problèmes de cache
        let userRef = firestore.get(/databases/(default)/documents/users/$(request.auth.uid));
        let userData = userRef.exists ? userRef.data : null;
        let docRef = firestore.get(/databases/(default)/documents/structures/$(structureId)/documents/$(fileId));
        
        // Si c'est un superadmin, accès autorisé
        return isSuperAdmin() ||
               // Sinon, vérifier que l'utilisateur appartient à la structure et que le document existe
               (belongsToStructure() && docRef.exists && (
                 // Si le document n'est pas restreint, accès autorisé
                 !docRef.data.isRestricted ||
                 // Si le document est restreint, vérifier le rôle
                 userData.status == 'admin' ||
                 (docRef.data.allowedRoles != null && 
                  docRef.data.allowedRoles.hasAny([userData.status]) &&
                  (userData.status == 'admin' || userData.status == 'member' || userData.status == 'membre'))
               ));
      }

      // Lecture : membres de la structure, avec vérification des restrictions
      // Version simplifiée pour debug : permettre à tous les utilisateurs authentifiés
      allow read: if request.auth != null;

      // Création : membres de la structure (pas de restriction pour la création)
      // Version simplifiée pour debug : permettre à tous les utilisateurs authentifiés
      allow create: if request.auth != null && request.resource.size < 100 * 1024 * 1024;

      // Modification : membres de la structure
      // Version simplifiée pour debug : permettre à tous les utilisateurs authentifiés
      allow update: if request.auth != null &&
        request.resource.size < 100 * 1024 * 1024; // 100MB max

      // Suppression : membres de la structure
      // Version simplifiée pour debug : permettre à tous les utilisateurs authentifiés
      allow delete: if request.auth != null;
    }
  }
} 